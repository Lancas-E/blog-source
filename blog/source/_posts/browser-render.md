---
title: 浏览器渲染机制
date: 2020-04-01 15:29:30
tags:
---
以chrome为例看看浏览器的渲染机制。
{% asset_img browser-render-1.png browser-render-1 %}

遍历DOM节点树创建一个“Frame 树”或“渲染树”，并计算每个节点的各个CSS样式值;
累加子节点的宽度，该节点的水平内边距(padding)、边框(border)和外边距(margin)，自底向上的计算"Frame 树"中每个节点的首选(preferred)宽度;
自顶向下的给每个节点的子节点分配可行宽度，计算每个节点的实际宽度;
应用文字折行、累加子节点的高度和此节点的内边距(padding)、边框(border)和外边距(margin)，自底向上的计算每个节点的高度
使用上面的计算结果构建每个节点的坐标;<!-- more -->
当存在元素使用 floated，位置有 absolutely 或 relatively 属性的时候，会有更多复杂的计算，详见http://dev.w3.org/csswg/css2/ 和 http://www.w3.org/Style/CSS/current-work;
创建layer(层)来表示页面中的哪些部分可以成组的被绘制，而不用被重新栅格化处理。每个帧对象都被分配给一个层;
每个层的帧对象都会被遍历，计算机执行绘图命令绘制各个层，此过程可能由CPU执行栅格化处理，或者直接通过D2D/SkiaGL在GPU上绘制;
上面所有步骤都可能利用到最近一次页面渲染时计算出来的各个值，这样可以减少不少计算量;
计算出各个层的最终位置，一组命令由 Direct3D/OpenGL发出，GPU命令缓冲区清空，命令传至GPU并异步渲染，帧被送到Window Server。


**帧**
{% blockquote  %}
在视频领域，电影、电视、数字视频等可视为随时间连续变换的许多张画面，而帧则指这些画面当中的每一张。
{% endblockquote %}

网页上来说，其实就是指浏览器渲染出的页面。目前大多数设备的屏幕刷新频率为60次/秒（60fps），每一帧所消耗的时间约为16ms（1000 ms / 60 = 16.66ms），但实际上，浏览器还有一些整理工作要做，因此开发者所做的所有工作需要在10ms内完成。
如果不能完成，帧率将会下降，网页会在屏幕上抖动，也就是通常所说的卡顿，这会对用户体验产生严重的负面影响。所以如果一个页面中有动画效果或者用户正在滚动页面，那么浏览器渲染动画或页面的速率也要尽可能地与设备屏幕的刷新频率保持一致，以保证良好的用户体验。

**像素管道**
提高帧率，其实就是优化浏览器渲染页面的过程。当你在工作时，需要了解并注意五个主要的区域，每个环节都可能卡顿，这些区域是你能在最大程度上去控制的地方，当然，也就是优化性能、提高帧率的地方。
- JavaScript：一般情况下，我们会使用JS去处理一些导致视觉变化的工作，比如动画或者增加DOM元素等。当然，除了JS，还有其他一些方法，比如：CSS Animations、Transitions、 Web Animation API
- Style calculations：这个过程是根据匹配选择器（.nav > .nav-item）计算出哪些CSS规则应用在哪些元素上面的过程
- Layout：浏览器知道对一个元素应用哪些规则之后，就可以开始计算这个元素占据的空间大小及其在屏幕上的位置
- Paint：绘制是填充像素的过程。它涉及绘出文本、颜色、图像、边框和阴影，基本上包含了元素的每个可视部分。绘制一般是在多个层上完成的
- Compositing（合成）：由于页面的不同部分可能被绘制到多个层上，因此它们需要按照正确的顺序绘制到屏幕上以正确渲染页面
{% asset_img browser-render-2.png browser-render-2 %}

帧不一定都会经过管道每个部分的处理。在改变视觉呈现时，针对指定帧，管道的运行通常有三种方式：

- JS / CSS > Style > Layout > Paint > Composite
当改变了某个元素的几何属性（如width、height，或者表示位置的left、top等）——即修改了该元素的“布局（layout）”属性，那么浏览器将会检查所有其他元素，然后对页面进行“重排（reflow）”。任何受到影响的区域都需要重新绘制，然后进行合成。
-JS / CSS > Style > Paint > Composite
当改变了只与绘制相关的属性（如背景图片、文字颜色或阴影等），即不会影响页面的布局，则浏览器会跳过布局阶段，但仍需要执行绘制、合成。
-JS / CSS > Style > Composite
当改变了一个既不需要“重排”也不需要“重绘”的属性（如transform），则浏览器将跳过布局、绘制阶段，直接执行合成。